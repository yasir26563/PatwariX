/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Subject, BehaviorSubject, timer, of, combineLatest, Subscription, EMPTY } from 'rxjs';
import { tap, delay, debounce, switchMap, takeUntil, finalize, filter } from 'rxjs/operators';
export class NgProgressRef {
    /**
     * @param {?} customConfig
     * @param {?} _onDestroyCallback
     */
    constructor(customConfig, _onDestroyCallback) {
        this._onDestroyCallback = _onDestroyCallback;
        // Progress start source event (used to cancel finalizing delays)
        this._started = new Subject();
        // Progress start event: stream that emits only when it hasn't already started
        this.started = this._started.pipe(filter((/**
         * @return {?}
         */
        () => !this.isStarted)));
        // Progress ended source event
        this._completed = new Subject();
        // Progress start event: stream that emits only when it has already started
        this.completed = this._completed.pipe(filter((/**
         * @return {?}
         */
        () => this.isStarted)));
        // Stream that increments and updates the progress state
        this._trickling = new Subject();
        // Stream that combines "_trickling" and "config" streams
        this._worker = Subscription.EMPTY;
        this._state = new BehaviorSubject({ active: false, value: 0 });
        this._config = new BehaviorSubject(customConfig);
        this.state = this._state.asObservable();
        this.config = this._state.asObservable();
        this._worker = combineLatest(this._trickling, this._config).pipe(debounce((/**
         * @param {?} __0
         * @return {?}
         */
        ([start, config]) => timer(start ? config.debounceTime : 0))), switchMap((/**
         * @param {?} __0
         * @return {?}
         */
        ([start, config]) => start ? this.onTrickling(config) : this.onComplete(config)))).subscribe();
    }
    // Get current progress state
    /**
     * @private
     * @return {?}
     */
    get currState() {
        return this._state.value;
    }
    // Check if progress has started
    /**
     * @return {?}
     */
    get isStarted() {
        return this.currState.active;
    }
    /**
     * Start the progress
     * @return {?}
     */
    start() {
        this._started.next();
        this._trickling.next(true);
    }
    /**
     * Complete the progress
     * @return {?}
     */
    complete() {
        this._trickling.next(false);
    }
    /**
     * Increment the progress
     * @param {?=} amount
     * @return {?}
     */
    inc(amount) {
        /** @type {?} */
        const n = this.currState.value;
        if (!this.isStarted) {
            this.start();
        }
        else {
            if (typeof amount !== 'number') {
                amount = this._config.value.trickleFunc(n);
            }
            this.set(n + amount);
        }
    }
    /**
     * Set the progress
     * @param {?} n
     * @return {?}
     */
    set(n) {
        this.setState({ value: this.clamp(n), active: true });
    }
    /**
     * Set config
     * @param {?} config
     * @return {?}
     */
    setConfig(config) {
        this._config.next(Object.assign({}, this._config.value, config));
    }
    /**
     * Destroy progress reference
     * @return {?}
     */
    destroy() {
        this._worker.unsubscribe();
        this._trickling.complete();
        this._state.complete();
        this._config.complete();
        this._started.complete();
        this._completed.complete();
        this._onDestroyCallback();
    }
    /**
     * Set progress state
     * @private
     * @param {?} state
     * @return {?}
     */
    setState(state) {
        this._state.next(Object.assign({}, this.currState, state));
    }
    /**
     * Clamps a value to be between min and max
     * @private
     * @param {?} n
     * @return {?}
     */
    clamp(n) {
        return Math.max(this._config.value.min, Math.min(this._config.value.max, n));
    }
    /**
     * Keeps incrementing the progress
     * @private
     * @param {?} config
     * @return {?}
     */
    onTrickling(config) {
        if (!this.isStarted) {
            this.set(this._config.value.min);
        }
        return timer(0, config.trickleSpeed).pipe(tap((/**
         * @return {?}
         */
        () => this.inc())));
    }
    /**
     * Completes then resets the progress
     * @private
     * @param {?} config
     * @return {?}
     */
    onComplete(config) {
        this._completed.next();
        return !this.isStarted ? EMPTY : of({}).pipe(
        // Complete the progress
        tap((/**
         * @return {?}
         */
        () => this.setState({ value: 100 }))), 
        // Deactivate the progress after a tiny delay
        delay(config.speed * 1.7), tap((/**
         * @return {?}
         */
        () => this.setState({ active: false }))), 
        // Use a tiny delay before resetting
        delay(config.speed), 
        // Force the progress to reset even it got cancelled
        finalize((/**
         * @return {?}
         */
        () => this.setState({ value: 0 }))), 
        // Cancel any of the finalizing delays if the progress has started again
        takeUntil(this._started));
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    NgProgressRef.prototype._state;
    /** @type {?} */
    NgProgressRef.prototype.state;
    /**
     * @type {?}
     * @private
     */
    NgProgressRef.prototype._config;
    /** @type {?} */
    NgProgressRef.prototype.config;
    /**
     * @type {?}
     * @private
     */
    NgProgressRef.prototype._started;
    /** @type {?} */
    NgProgressRef.prototype.started;
    /**
     * @type {?}
     * @private
     */
    NgProgressRef.prototype._completed;
    /** @type {?} */
    NgProgressRef.prototype.completed;
    /**
     * @type {?}
     * @private
     */
    NgProgressRef.prototype._trickling;
    /**
     * @type {?}
     * @private
     */
    NgProgressRef.prototype._worker;
    /**
     * @type {?}
     * @private
     */
    NgProgressRef.prototype._onDestroyCallback;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctcHJvZ3Jlc3MtcmVmLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LXByb2dyZXNzYmFyLyIsInNvdXJjZXMiOlsibGliL25nLXByb2dyZXNzLXJlZi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFjLE9BQU8sRUFBRSxlQUFlLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxhQUFhLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMzRyxPQUFPLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHOUYsTUFBTSxPQUFPLGFBQWE7Ozs7O0lBb0N4QixZQUFZLFlBQThCLEVBQVUsa0JBQThCO1FBQTlCLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBWTs7UUF6QmpFLGFBQVEsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDOztRQUVqQyxZQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsTUFBTTs7O1FBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFDLENBQUMsQ0FBQzs7UUFHcEQsZUFBVSxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7O1FBRW5DLGNBQVMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxNQUFNOzs7UUFBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFDLENBQUMsQ0FBQzs7UUFHdkQsZUFBVSxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7O1FBRzNCLFlBQU8sR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDO1FBYTVDLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxlQUFlLENBQWtCLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNoRixJQUFJ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SyxHQUFHLEdBQUcsQ0FBQyxFQUN6QixHQUFHOzs7UUFBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUM7UUFFM0Msb0NBQW9DO1FBQ3BDLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDO1FBQ25CLG9EQUFvRDtRQUNwRCxRQUFROzs7UUFBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUM7UUFDM0Msd0VBQXdFO1FBQ3hFLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQ3pCLENBQUM7SUFDSixDQUFDO0NBQ0Y7Ozs7OztJQW5KQywrQkFBMEQ7O0lBQzFELDhCQUFtQzs7Ozs7SUFHbkMsZ0NBQTREOztJQUM1RCwrQkFBb0M7Ozs7O0lBR3BDLGlDQUEwQzs7SUFFMUMsZ0NBQXFFOzs7OztJQUdyRSxtQ0FBNEM7O0lBRTVDLGtDQUF3RTs7Ozs7SUFHeEUsbUNBQTRDOzs7OztJQUc1QyxnQ0FBOEM7Ozs7O0lBWUYsMkNBQXNDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCwgQmVoYXZpb3JTdWJqZWN0LCB0aW1lciwgb2YsIGNvbWJpbmVMYXRlc3QsIFN1YnNjcmlwdGlvbiwgRU1QVFkgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgdGFwLCBkZWxheSwgZGVib3VuY2UsIHN3aXRjaE1hcCwgdGFrZVVudGlsLCBmaW5hbGl6ZSwgZmlsdGVyIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBOZ1Byb2dyZXNzU3RhdGUsIE5nUHJvZ3Jlc3NDb25maWcgfSBmcm9tICcuL25nLXByb2dyZXNzLmludGVyZmFjZSc7XHJcblxyXG5leHBvcnQgY2xhc3MgTmdQcm9ncmVzc1JlZiB7XHJcblxyXG4gIC8vIFN0cmVhbSB0aGF0IGVtaXRzIHdoZW4gcHJvZ3Jlc3Mgc3RhdGUgaXMgY2hhbmdlZFxyXG4gIHByaXZhdGUgcmVhZG9ubHkgX3N0YXRlOiBCZWhhdmlvclN1YmplY3Q8TmdQcm9ncmVzc1N0YXRlPjtcclxuICBzdGF0ZTogT2JzZXJ2YWJsZTxOZ1Byb2dyZXNzU3RhdGU+O1xyXG5cclxuICAvLyBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIGNvbmZpZyBpcyBjaGFuZ2VkXHJcbiAgcHJpdmF0ZSByZWFkb25seSBfY29uZmlnOiBCZWhhdmlvclN1YmplY3Q8TmdQcm9ncmVzc0NvbmZpZz47XHJcbiAgY29uZmlnOiBPYnNlcnZhYmxlPE5nUHJvZ3Jlc3NTdGF0ZT47XHJcblxyXG4gIC8vIFByb2dyZXNzIHN0YXJ0IHNvdXJjZSBldmVudCAodXNlZCB0byBjYW5jZWwgZmluYWxpemluZyBkZWxheXMpXHJcbiAgcHJpdmF0ZSByZWFkb25seSBfc3RhcnRlZCA9IG5ldyBTdWJqZWN0KCk7XHJcbiAgLy8gUHJvZ3Jlc3Mgc3RhcnQgZXZlbnQ6IHN0cmVhbSB0aGF0IGVtaXRzIG9ubHkgd2hlbiBpdCBoYXNuJ3QgYWxyZWFkeSBzdGFydGVkXHJcbiAgcmVhZG9ubHkgc3RhcnRlZCA9IHRoaXMuX3N0YXJ0ZWQucGlwZShmaWx0ZXIoKCkgPT4gIXRoaXMuaXNTdGFydGVkKSk7XHJcblxyXG4gIC8vIFByb2dyZXNzIGVuZGVkIHNvdXJjZSBldmVudFxyXG4gIHByaXZhdGUgcmVhZG9ubHkgX2NvbXBsZXRlZCA9IG5ldyBTdWJqZWN0KCk7XHJcbiAgLy8gUHJvZ3Jlc3Mgc3RhcnQgZXZlbnQ6IHN0cmVhbSB0aGF0IGVtaXRzIG9ubHkgd2hlbiBpdCBoYXMgYWxyZWFkeSBzdGFydGVkXHJcbiAgcmVhZG9ubHkgY29tcGxldGVkID0gdGhpcy5fY29tcGxldGVkLnBpcGUoZmlsdGVyKCgpID0+IHRoaXMuaXNTdGFydGVkKSk7XHJcblxyXG4gIC8vIFN0cmVhbSB0aGF0IGluY3JlbWVudHMgYW5kIHVwZGF0ZXMgdGhlIHByb2dyZXNzIHN0YXRlXHJcbiAgcHJpdmF0ZSByZWFkb25seSBfdHJpY2tsaW5nID0gbmV3IFN1YmplY3QoKTtcclxuXHJcbiAgLy8gU3RyZWFtIHRoYXQgY29tYmluZXMgXCJfdHJpY2tsaW5nXCIgYW5kIFwiY29uZmlnXCIgc3RyZWFtc1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgX3dvcmtlciA9IFN1YnNjcmlwdGlvbi5FTVBUWTtcclxuXHJcbiAgLy8gR2V0IGN1cnJlbnQgcHJvZ3Jlc3Mgc3RhdGVcclxuICBwcml2YXRlIGdldCBjdXJyU3RhdGUoKTogTmdQcm9ncmVzc1N0YXRlIHtcclxuICAgIHJldHVybiB0aGlzLl9zdGF0ZS52YWx1ZTtcclxuICB9XHJcblxyXG4gIC8vIENoZWNrIGlmIHByb2dyZXNzIGhhcyBzdGFydGVkXHJcbiAgZ2V0IGlzU3RhcnRlZCgpOiBib29sZWFuIHtcclxuICAgIHJldHVybiB0aGlzLmN1cnJTdGF0ZS5hY3RpdmU7XHJcbiAgfVxyXG5cclxuICBjb25zdHJ1Y3RvcihjdXN0b21Db25maWc6IE5nUHJvZ3Jlc3NDb25maWcsIHByaXZhdGUgX29uRGVzdHJveUNhbGxiYWNrOiAoKSA9PiB2b2lkKSB7XHJcbiAgICB0aGlzLl9zdGF0ZSA9IG5ldyBCZWhhdmlvclN1YmplY3Q8TmdQcm9ncmVzc1N0YXRlPih7IGFjdGl2ZTogZmFsc2UsIHZhbHVlOiAwIH0pO1xyXG4gICAgdGhpcy5fY29uZmlnID0gbmV3IEJlaGF2aW9yU3ViamVjdDxOZ1Byb2dyZXNzQ29uZmlnPihjdXN0b21Db25maWcpO1xyXG4gICAgdGhpcy5zdGF0ZSA9IHRoaXMuX3N0YXRlLmFzT2JzZXJ2YWJsZSgpO1xyXG4gICAgdGhpcy5jb25maWcgPSB0aGlzLl9zdGF0ZS5hc09ic2VydmFibGUoKTtcclxuXHJcbiAgICB0aGlzLl93b3JrZXIgPSBjb21iaW5lTGF0ZXN0KHRoaXMuX3RyaWNrbGluZywgdGhpcy5fY29uZmlnKS5waXBlKFxyXG4gICAgICBkZWJvdW5jZSgoW3N0YXJ0LCBjb25maWddOiBbYm9vbGVhbiwgTmdQcm9ncmVzc0NvbmZpZ10pID0+IHRpbWVyKHN0YXJ0ID8gY29uZmlnLmRlYm91bmNlVGltZSA6IDApKSxcclxuICAgICAgc3dpdGNoTWFwKChbc3RhcnQsIGNvbmZpZ106IFtib29sZWFuLCBOZ1Byb2dyZXNzQ29uZmlnXSkgPT4gc3RhcnQgPyB0aGlzLm9uVHJpY2tsaW5nKGNvbmZpZykgOiB0aGlzLm9uQ29tcGxldGUoY29uZmlnKSlcclxuICAgICkuc3Vic2NyaWJlKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTdGFydCB0aGUgcHJvZ3Jlc3NcclxuICAgKi9cclxuICBzdGFydCgpIHtcclxuICAgIHRoaXMuX3N0YXJ0ZWQubmV4dCgpO1xyXG4gICAgdGhpcy5fdHJpY2tsaW5nLm5leHQodHJ1ZSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDb21wbGV0ZSB0aGUgcHJvZ3Jlc3NcclxuICAgKi9cclxuICBjb21wbGV0ZSgpIHtcclxuICAgIHRoaXMuX3RyaWNrbGluZy5uZXh0KGZhbHNlKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEluY3JlbWVudCB0aGUgcHJvZ3Jlc3NcclxuICAgKi9cclxuICBpbmMoYW1vdW50PzogbnVtYmVyKSB7XHJcbiAgICBjb25zdCBuID0gdGhpcy5jdXJyU3RhdGUudmFsdWU7XHJcbiAgICBpZiAoIXRoaXMuaXNTdGFydGVkKSB7XHJcbiAgICAgIHRoaXMuc3RhcnQoKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGlmICh0eXBlb2YgYW1vdW50ICE9PSAnbnVtYmVyJykge1xyXG4gICAgICAgIGFtb3VudCA9IHRoaXMuX2NvbmZpZy52YWx1ZS50cmlja2xlRnVuYyhuKTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLnNldChuICsgYW1vdW50KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNldCB0aGUgcHJvZ3Jlc3NcclxuICAgKi9cclxuICBzZXQobjogbnVtYmVyKSB7XHJcbiAgICB0aGlzLnNldFN0YXRlKHsgdmFsdWU6IHRoaXMuY2xhbXAobiksIGFjdGl2ZTogdHJ1ZSB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNldCBjb25maWdcclxuICAgKi9cclxuICBzZXRDb25maWcoY29uZmlnOiBOZ1Byb2dyZXNzQ29uZmlnKSB7XHJcbiAgICB0aGlzLl9jb25maWcubmV4dCh7IC4uLnRoaXMuX2NvbmZpZy52YWx1ZSwgLi4uY29uZmlnIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRGVzdHJveSBwcm9ncmVzcyByZWZlcmVuY2VcclxuICAgKi9cclxuICBkZXN0cm95KCkge1xyXG4gICAgdGhpcy5fd29ya2VyLnVuc3Vic2NyaWJlKCk7XHJcbiAgICB0aGlzLl90cmlja2xpbmcuY29tcGxldGUoKTtcclxuICAgIHRoaXMuX3N0YXRlLmNvbXBsZXRlKCk7XHJcbiAgICB0aGlzLl9jb25maWcuY29tcGxldGUoKTtcclxuICAgIHRoaXMuX3N0YXJ0ZWQuY29tcGxldGUoKTtcclxuICAgIHRoaXMuX2NvbXBsZXRlZC5jb21wbGV0ZSgpO1xyXG4gICAgdGhpcy5fb25EZXN0cm95Q2FsbGJhY2soKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNldCBwcm9ncmVzcyBzdGF0ZVxyXG4gICAqL1xyXG4gIHByaXZhdGUgc2V0U3RhdGUoc3RhdGU6IE5nUHJvZ3Jlc3NTdGF0ZSkge1xyXG4gICAgdGhpcy5fc3RhdGUubmV4dCh7IC4uLnRoaXMuY3VyclN0YXRlLCAuLi5zdGF0ZSB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENsYW1wcyBhIHZhbHVlIHRvIGJlIGJldHdlZW4gbWluIGFuZCBtYXhcclxuICAgKi9cclxuICBwcml2YXRlIGNsYW1wKG46IG51bWJlcik6IG51bWJlciB7XHJcbiAgICByZXR1cm4gTWF0aC5tYXgodGhpcy5fY29uZmlnLnZhbHVlLm1pbiwgTWF0aC5taW4odGhpcy5fY29uZmlnLnZhbHVlLm1heCwgbikpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogS2VlcHMgaW5jcmVtZW50aW5nIHRoZSBwcm9ncmVzc1xyXG4gICAqL1xyXG4gIHByaXZhdGUgb25Ucmlja2xpbmcoY29uZmlnOiBOZ1Byb2dyZXNzQ29uZmlnKTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcclxuICAgIGlmICghdGhpcy5pc1N0YXJ0ZWQpIHtcclxuICAgICAgdGhpcy5zZXQodGhpcy5fY29uZmlnLnZhbHVlLm1pbik7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGltZXIoMCwgY29uZmlnLnRyaWNrbGVTcGVlZCkucGlwZSh0YXAoKCkgPT4gdGhpcy5pbmMoKSkpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ29tcGxldGVzIHRoZW4gcmVzZXRzIHRoZSBwcm9ncmVzc1xyXG4gICAqL1xyXG4gIHByaXZhdGUgb25Db21wbGV0ZShjb25maWc6IE5nUHJvZ3Jlc3NDb25maWcpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgdGhpcy5fY29tcGxldGVkLm5leHQoKTtcclxuICAgIHJldHVybiAhdGhpcy5pc1N0YXJ0ZWQgPyBFTVBUWSA6IG9mKHt9KS5waXBlKFxyXG4gICAgICAvLyBDb21wbGV0ZSB0aGUgcHJvZ3Jlc3NcclxuICAgICAgdGFwKCgpID0+IHRoaXMuc2V0U3RhdGUoeyB2YWx1ZTogMTAwIH0pKSxcclxuXHJcbiAgICAgIC8vIERlYWN0aXZhdGUgdGhlIHByb2dyZXNzIGFmdGVyIGEgdGlueSBkZWxheVxyXG4gICAgICBkZWxheShjb25maWcuc3BlZWQgKiAxLjcpLFxyXG4gICAgICB0YXAoKCkgPT4gdGhpcy5zZXRTdGF0ZSh7IGFjdGl2ZTogZmFsc2UgfSkpLFxyXG5cclxuICAgICAgLy8gVXNlIGEgdGlueSBkZWxheSBiZWZvcmUgcmVzZXR0aW5nXHJcbiAgICAgIGRlbGF5KGNvbmZpZy5zcGVlZCksXHJcbiAgICAgIC8vIEZvcmNlIHRoZSBwcm9ncmVzcyB0byByZXNldCBldmVuIGl0IGdvdCBjYW5jZWxsZWRcclxuICAgICAgZmluYWxpemUoKCkgPT4gdGhpcy5zZXRTdGF0ZSh7IHZhbHVlOiAwIH0pKSxcclxuICAgICAgLy8gQ2FuY2VsIGFueSBvZiB0aGUgZmluYWxpemluZyBkZWxheXMgaWYgdGhlIHByb2dyZXNzIGhhcyBzdGFydGVkIGFnYWluXHJcbiAgICAgIHRha2VVbnRpbCh0aGlzLl9zdGFydGVkKVxyXG4gICAgKTtcclxuICB9XHJcbn1cclxuIl19